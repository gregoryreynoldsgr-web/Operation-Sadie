<script>
  // Enhance Shorts embeds for iOS/branding flags (unchanged)
  (function enhanceShorts(){
    const isiOS = /iP(hone|ad|od)/i.test(navigator.userAgent);
    document.querySelectorAll('.short iframe').forEach(el => {
      try {
        const u = new URL(el.src, location.href);
        if (u.hostname.includes('youtube.com')) {
          u.searchParams.set('rel','0');
          u.searchParams.set('modestbranding','1');
          u.searchParams.set('enablejsapi','1');
          u.searchParams.set('origin', location.origin);
          u.searchParams.set('playsinline', isiOS ? '0' : '1');
          u.searchParams.set('fs','1');
          el.src = u.toString();
          el.classList.add('yt-embed');
        }
      } catch(_) {}
    });
    if(!window._ytLoaded){
      const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api';
      document.head.appendChild(tag); window._ytLoaded=true;
    }
  })();

  // Long-form lightbox player
  let player;
  const lightbox = document.getElementById('lightbox');
  const closeBtn = document.getElementById('closeBtn');
  const longGrid = document.getElementById('longGrid');

  function onYouTubeIframeAPIReady(){
    player = new YT.Player('ytPlayer', {
      height:'100%', width:'100%', videoId:'',
      playerVars:{ rel:0, modestbranding:1, autoplay:1, controls:1, playsinline:1, fs:1 },
      events:{ 'onStateChange': onPlayerStateChange }
    });
  }
  window.onYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady || onYouTubeIframeAPIReady;

  function onPlayerStateChange(e){
    if (e.data === YT.PlayerState.ENDED) closeVideo();
  }

  function openVideo(id){
    lightbox.classList.add('open');
    try { player.loadVideoById(id); } catch(e){}
  }
  function closeVideo(){
    lightbox.classList.remove('open');
    try { player.stopVideo(); } catch(e){}
  }

  // ---- NEW: close overlay when exiting fullscreen (so you don't have to press ESC) ----
  function isFullscreen(){
    return document.fullscreenElement
        || document.webkitFullscreenElement
        || document.mozFullScreenElement
        || document.msFullscreenElement;
  }
  function onFullscreenChange(){
    // Only act on EXIT from fullscreen; do nothing while entering/inside
    if (!isFullscreen() && lightbox.classList.contains('open')) {
      // small timeout lets the iframe finish its own exit animation
      setTimeout(closeVideo, 50);
    }
  }
  ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange']
    .forEach(evt => document.addEventListener(evt, onFullscreenChange));
  // ---------------------------------------------------------------------------

  longGrid.addEventListener('click', (e)=>{
    const card = e.target.closest('.card'); if(!card) return;
    openVideo(card.dataset.yt);
  });
  closeBtn.addEventListener('click', closeVideo);
  lightbox.addEventListener('click', (e)=>{ if(e.target === lightbox) closeVideo(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeVideo(); });
</script>
